---
- name: Setup Proxmox Firewall
  hosts: proxmox
  become: yes
  vars_files:
    - ../group_vars/proxmox.yml
  
  tasks:
    - name: Ensure pve-firewall service is running
      service:
        name: pve-firewall
        state: started
        enabled: yes
        
    - name: Configure Proxmox built-in firewall
      shell: |
        pvesh set /cluster/firewall/options --enable 1
        pvesh set /nodes/{{ pve_node }}/firewall/options --enable 1
      ignore_errors: yes
      
    - name: Create Proxmox firewall rules directory
      file:
        path: /etc/pve/firewall
        state: directory
        mode: '0755'
        
    - name: Configure cluster firewall rules
      copy:
        content: |
          [OPTIONS]
          enable: 1
          policy_in: DROP
          policy_out: ACCEPT
          
          [IPSET management]
          65.109.114.0/26
          10.0.1.0/24
          10.0.2.0/24
          
          [RULES]
          IN SSH(ACCEPT) -source +management
          IN ACCEPT -i vmbr1
          IN ACCEPT -i vmbr2
          IN ACCEPT -p tcp -dport 8006 -source +management
          IN ACCEPT -p tcp -dport 5900:5999 -source +management
        dest: /etc/pve/firewall/cluster.fw
        backup: yes
        
    - name: Show final firewall status
      shell: pve-firewall status
      register: firewall_status
      changed_when: false
      
    - name: Display firewall configuration
      debug:
        msg: "{{ firewall_status.stdout_lines }}"